<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Игра 21 — браузерная версия</title>

  <!-- ИКОНКИ -->
  <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#106b2e">
  <!-- /ИКОНКИ -->

<style>
  :root{
    --bg:#222; --panel:#2b2b2b; --table:#106b2e; --text:#fff; --accent:#ffd54f;
    --chip-green:#2ecc71; --chip-red:#e74c3c; --muted:#bbb; --danger:#ef5350; --good:#9CCC65; --win:#00e676;
    --streak-fire:#ff6b35; --achievement-gold:#ffd700;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 "Segoe UI",system-ui,Arial,sans-serif}
  .wrap{max-width:1000px;margin:0 auto;padding:16px}

  /* Game icon in title */
  .game-title-icon{width:24px;height:24px;display:inline-block;vertical-align:middle;margin-right:8px}

  /* Панели */
  .panel{background:var(--panel);border:1px solid #444;border-radius:14px;box-shadow:0 6px 14px rgba(0,0,0,.25);transition:transform .2s ease}
  .panel:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,.3)}
  
  #scorePanel{display:flex;flex-direction:column;align-items:center;gap:6px;padding:10px 14px;margin:8px auto;position:relative}

  /* Streak indicator */
  .streak-indicator{position:absolute;right:14px;top:50%;transform:translateY(-50%);font-weight:900;font-size:18px;opacity:0;transition:opacity .3s ease}
  .streak-indicator.show{opacity:1}
  .streak-indicator.fire{color:var(--streak-fire);animation:flame 1s ease-in-out infinite}
  @keyframes flame{0%,100%{transform:translateY(-50%) scale(1)}50%{transform:translateY(-50%) scale(1.1)}}

  #chips{display:flex;align-items:center;gap:22px}
  .chips{display:flex;gap:8px}
  .chip{width:12px;height:12px;border-radius:50%;background:#555;transition:all .15s ease;cursor:pointer;position:relative}
  .chip.active{transform:scale(1.05);box-shadow:0 0 8px rgba(255,255,255,0.3)}
  .chip.green.active{background:var(--chip-green)}
  .chip.red.active{background:var(--chip-red)}
  .chip.win{animation:pop .35s ease}
  .chip:hover::after{content:attr(title);position:absolute;bottom:20px;left:50%;transform:translateX(-50%);background:#000;color:#fff;padding:4px 8px;border-radius:6px;font-size:12px;white-space:nowrap;opacity:0.9}
  @keyframes pop{from{transform:scale(.7)}to{transform:scale(1.05)}}

  /* Top buttons */
  .top-buttons{position:absolute;top:18px;display:flex;gap:8px}
  .top-buttons.left{left:20px}
  .top-buttons.right{right:20px}
  
  .icon-btn{background:#444;color:#fff;border:none;border-radius:10px;padding:6px 10px;font-weight:700;cursor:pointer;transition:all .2s ease}
  .icon-btn:hover{background:#555;transform:translateY(-1px)}
  .icon-btn:active{transform:translateY(1px)}

  /* Language selector */
  .lang-selector{display:flex;gap:4px;background:#444;border-radius:10px;padding:4px}
  .lang-btn{background:transparent;border:none;cursor:pointer;padding:4px 8px;border-radius:6px;transition:all .2s ease;font-size:20px}
  .lang-btn:hover{background:#555}
  .lang-btn.active{background:#666}

  /* Stats Panel */
  #statsPanel{display:none;margin:10px auto;padding:14px 16px;max-width:400px}
  .stat-row{display:flex;justify-content:space-between;margin:6px 0;padding:6px 0;border-bottom:1px solid #333}
  .stat-row:last-child{border:none}
  .stat-label{color:#aaa}
  .stat-value{font-weight:700;color:var(--accent)}
  .panel-buttons{display:flex;gap:8px;margin-top:12px;justify-content:center}
  .danger-btn{background:#c62828}
  .danger-btn:hover{background:#d32f2f}

  /* Achievements Panel */
  #achievementsPanel{display:none;margin:10px auto;padding:14px 16px;max-width:500px}
  .achievement-item{display:flex;align-items:center;gap:12px;padding:10px;margin:6px 0;background:#333;border-radius:10px;transition:all .2s ease}
  .achievement-item.unlocked{background:#1b5e20;border:1px solid #2e7d32}
  .achievement-item.locked{opacity:0.6}
  .achievement-icon{font-size:24px}
  .achievement-info{flex:1}
  .achievement-name{font-weight:700;color:var(--accent)}
  .achievement-desc{font-size:14px;color:#aaa}
  .achievement-status{font-size:20px}

  /* Achievement notification */
  .achievement-notification{
    position:fixed;top:20px;left:50%;transform:translateX(-50%);
    background:linear-gradient(135deg,var(--achievement-gold),#ffed4e);
    color:#000;padding:16px 24px;border-radius:12px;
    box-shadow:0 8px 24px rgba(0,0,0,.4);
    font-weight:800;text-align:center;z-index:5000;
    animation:achievementPop .5s ease;
  }
  @keyframes achievementPop{
    from{transform:translate(-50%,-100px);opacity:0}
    to{transform:translate(-50%,0);opacity:1}
  }

  /* Стол */
  #table{position:relative;background:var(--table);border-radius:16px;padding:26px;margin-top:12px;overflow:hidden}
  #table::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at center,transparent 0%,rgba(0,0,0,0.3) 100%);pointer-events:none}
  
  h1{margin:0 0 8px;text-align:center;color:var(--accent);text-shadow:2px 2px 4px rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;gap:8px}
  
  /* мини-колода для анимации */
  #deckStub{
    position:absolute; left:18px; top:18px; width:56px; height:78px;
    border-radius:10px; border:2px dashed #111; opacity:.45; box-shadow:2px 2px 0 #111;
    background:repeating-linear-gradient(45deg,#ffffff08 0 6px,#ffffff16 6px 12px);
    transition:transform .2s ease;
  }
  #deckStub.pulse{animation:deckPulse .4s ease}
  @keyframes deckPulse{0%,100%{transform:scale(1)}50%{transform:scale(0.95)}}
  
  .hand{margin-top:26px;position:relative;display:flex;flex-direction:column;align-items:center}
  .hand.thinking{animation:pulse 1s ease-in-out infinite}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.8}}
  
  .hand .who{color:var(--accent);font-weight:800;margin-bottom:8px}
  .cards{display:flex;gap:14px;flex-wrap:wrap;justify-content:center;min-height:78px}
  .total{position:absolute;right:14px;top:50%;transform:translateY(-50%);font-weight:800}
  .badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#1f1f1f;color:var(--accent);
         font-weight:800;border:1px solid #444;box-shadow:0 2px 10px rgba(0,0,0,.25);transition:all .2s ease}
  .badge.good{color:var(--good)} .badge.win{color:var(--win)} .badge.bad{color:var(--danger)}

  /* Баблы */
  .bubble{position:absolute;top:-12px;left:50%;transform:translateX(-50%);
          background:#1f1f1f;border:1px solid #444;color:#fff;padding:6px 10px;border-radius:12px;
          font-weight:800;opacity:0;pointer-events:none;transition:opacity .2s,transform .2s; z-index:20;}
  .bubble.show{opacity:1;transform:translate(-50%,-4px)}

  /* Карты */
  .card{position:relative;width:56px;height:78px;background:#fff;border-radius:10px;border:2px solid #111;
        box-shadow:2px 2px 0 #111;display:flex;align-items:center;justify-content:center;font-weight:800;
        transition:transform .22s ease, opacity .22s ease, box-shadow .2s ease;cursor:pointer}
  .card:hover{transform:translateY(-5px) rotate(2deg);box-shadow:4px 4px 8px rgba(0,0,0,0.3)}
  .card.grey{background:#e6e6e6}
  .card.red{color:#e53935} .card.black{color:#111}
  .card .corner{position:absolute;font-size:14px}
  .card .tl{left:6px;top:6px} .card .br{right:6px;bottom:6px}
  .card .value{font-size:18px}
  .card.enter{transform:translateY(-14px);opacity:0}
  .card.dealing{animation:cardFlip 0.4s ease-out}
  @keyframes cardFlip{0%{transform:rotateY(180deg) scale(0.8)}100%{transform:rotateY(0deg) scale(1)}}
  .card.flash{animation:flash .45s ease}
  .card .pill{position:absolute;right:-8px;top:-8px;background:#222;color:#ffd54f;
              border:1px solid #444;border-radius:999px;padding:2px 6px;font-size:12px;font-weight:900;
              animation:pillPop .3s ease}
  @keyframes flash{0%{box-shadow:0 0 0 0 rgba(255,255,255,.6)}100%{box-shadow:2px 2px 0 #111}}
  @keyframes pillPop{from{transform:scale(0)}to{transform:scale(1)}}

  /* летящая карта */
  .card.fly{position:fixed; z-index:40; left:0; top:0; transform:translate(0,0) scale(.92); transition:transform .32s ease; pointer-events:none}

  /* Тоасты */
  #toast{
    position:absolute; left:50%; bottom:90px; transform:translateX(-50%);
    pointer-events:none; display:flex; flex-direction:column; gap:8px; align-items:center; z-index:30;
  }
  .toast{
    background:#000c;color:#fff;padding:8px 12px;border-radius:10px;font-weight:800;border:1px solid #444;
    opacity:0;transform:translateY(6px);transition:opacity .25s,transform .25s;box-shadow:0 8px 18px rgba(0,0,0,.35)
  }
  .toast.show{opacity:1;transform:translateY(0)}
  .toast.win{color:#00e676;border-color:#00e676}
  .toast.lose{color:#ef5350;border-color:#ef5350}
  .toast.info{color:#ffd54f}
  .toast.streak{background:linear-gradient(135deg,#ff6b35,#ffd54f);color:#000;border:none}

  /* Кнопки */
  .btn-row{display:flex;justify-content:center;gap:12px;margin-top:12px}
  .btn{background:#333;color:#fff;border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;
       min-height:44px;letter-spacing:.2px;box-shadow:0 4px 0 #222;transition:all .15s ease;position:relative;overflow:hidden}
  .btn::before{content:'';position:absolute;inset:0;background:linear-gradient(45deg,transparent,rgba(255,255,255,0.1),transparent);
               transform:translateX(-100%);transition:transform .6s ease}
  .btn:hover::before{transform:translateX(100%)}
  .btn:hover{transform:translateY(-1px);box-shadow:0 5px 0 #222}
  .btn:active{transform:translateY(1px);box-shadow:0 3px 0 #222}
  .btn:focus-visible{outline:3px solid var(--win);outline-offset:2px;border-radius:12px}
  .btn[disabled]{opacity:.55;cursor:not-allowed}
  .btn[disabled]:hover{transform:none;box-shadow:0 4px 0 #222}

  /* Keyboard hints */
  .kbd-hint{position:absolute;bottom:-20px;left:50%;transform:translateX(-50%);font-size:11px;
            color:#666;opacity:0;transition:opacity .2s ease}
  .btn:hover .kbd-hint{opacity:1}

  /* Статус */
  #status{text-align:center;color:var(--muted);margin-top:8px;font-weight:600}
  #status.thinking::after{
    content:"";display:inline-block;width:36px;height:10px;margin-left:6px;--c:#bbb;
    background:radial-gradient(var(--c) 2px,transparent 3px) 0 50%/12px 10px repeat-x;    
    animation:dots 1s steps(3,end) infinite;
  }
  #status.ok{color:#00e676} #status.bad{color:#ef5350} #status.neutral{color:#bbb}
  @keyframes dots{from{background-position:0 50%}to{background-position:-36px 50%}}

  /* Пост-панель */
  #postPanel{display:none;margin:10px auto 0;padding:10px 12px;max-width:520px}
  #postPanel .row{display:flex;gap:10px;justify-content:center}
  #postSummary{text-align:center;margin:-2px 0 8px;color:#ddd;font-weight:700}

  /* Меню */
  #menuOverlay{position:fixed; inset:0; background:rgba(0,0,0,.75);display:flex; align-items:center; justify-content:center;z-index:2000;backdrop-filter:blur(4px)}
  #menu{width:min(560px,92%);padding:16px 18px;animation:menuSlide .3s ease}
  @keyframes menuSlide{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}
  .menu-title{font-size:24px;color:var(--accent);font-weight:900;text-align:center;margin:6px 0;display:flex;align-items:center;justify-content:center;gap:8px}
  .menu-sub{opacity:.9;text-align:center;margin-bottom:10px}
  .menu-row{display:flex;align-items:center;gap:12px;margin:8px 0;justify-content:center;flex-wrap:wrap}
  .menu-btns{display:flex;gap:10px;justify-content:center;margin-top:10px;flex-wrap:wrap}
  .spin{width:70px;padding:6px 8px;border-radius:10px;border:1px solid #666;background:#1f1f1f;color:#fff}
  label{cursor:pointer;transition:color .2s ease}
  label:hover{color:var(--accent)}
  select, .chk{background:#1f1f1f;border:1px solid #666;color:#fff;border-radius:10px;padding:6px 8px}

  /* Модалка конца матча */
  #resultOverlay{position:fixed; inset:0; background:rgba(0,0,0,.65);display:none; align-items:center; justify-content:center;z-index:3000;backdrop-filter:blur(4px)}
  #resultModal{background:var(--panel);border:1px solid #444;border-radius:14px;padding:16px 18px;
               width:min(420px,92%);box-shadow:0 12px 32px rgba(0,0,0,.4);text-align:center;animation:modalPop .3s ease}
  #resultModal h3{margin:6px 0 8px;color:var(--accent);animation:pop .5s ease}
  #resultModal p{margin:0 0 12px;color:#ddd}
  #resultModal .row{display:flex;gap:10px;justify-content:center}
  #okBtn{background:#2e7d32}
  #okBtn:hover{background:#388e3c}
  @keyframes modalPop{from{transform:scale(0.9);opacity:0}to{transform:scale(1);opacity:1}}

  /* Футер */
  footer{max-width:900px;margin:12px auto 20px;color:#999;text-align:center;font-size:14px}

  /* Screen reader only */
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

  /* Адаптив */
  @media (max-width:560px){
    .wrap{padding:10px}
    #table{padding:18px}
    .btn-row{position:sticky;bottom:10px;z-index:2;background:rgba(34,34,34,0.9);padding:10px;border-radius:12px;backdrop-filter:blur(10px)}
    .btn{min-height:48px;min-width:120px;font-size:16px}
    .cards{gap:10px}
    .card{width:48px;height:67px}
    .card .corner{font-size:12px}
    .card .value{font-size:16px}
    .total{position:static;transform:none;margin-top:6px}
    #toast{bottom:110px}
    .top-buttons{position:static;margin:8px auto;justify-content:center}
    .lang-selector{margin:8px auto}
  }
  @media (prefers-reduced-motion:reduce){
    *{animation:none !important;transition:none !important}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="top-buttons left">
      <button id="menuBtn" class="icon-btn">≡ <span id="menuText">Меню</span></button>
    </div>
    
    <div class="top-buttons right">
      <button id="statsBtn" class="icon-btn">📊</button>
      <button id="achievementsBtn" class="icon-btn">🏆</button>
      <div class="lang-selector">
        <button class="lang-btn active" data-lang="ru">🇷🇺</button>
        <button class="lang-btn" data-lang="en">🇬🇧</button>
      </div>
    </div>

    <div id="scorePanel" class="panel" aria-live="polite">
      <div id="scoreLabel" style="color:var(--accent);font-weight:900;">Счёт</div>
      <div id="scoreText" style="font-weight:800;">Ты 0 - 0 Бот</div>
      <div id="chips">
        <div id="chipsL" class="chips"></div>
        <div style="opacity:.9">vs</div>
        <div id="chipsR" class="chips"></div>
      </div>
      <div class="streak-indicator" id="streakIndicator"></div>
    </div>

    <!-- Stats Panel -->
    <div id="statsPanel" class="panel" style="display:none;">
      <h3 style="text-align:center;color:var(--accent);margin:8px 0;">📊 <span id="statsTitle">Статистика</span></h3>
      <div class="stat-row">
        <span class="stat-label" id="winRateLabel">Процент побед:</span>
        <span class="stat-value" id="winRate">0%</span>
      </div>
      <div class="stat-row">
        <span class="stat-label" id="avgHandLabel">Средняя рука:</span>
        <span class="stat-value" id="avgHand">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-label" id="bustRateLabel">Частота перебора:</span>
        <span class="stat-value" id="bustRate">0%</span>
      </div>
      <div class="stat-row">
        <span class="stat-label" id="totalGamesLabel">Всего игр:</span>
        <span class="stat-value" id="totalGames">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-label" id="bestStreakLabel">Лучшая серия:</span>
        <span class="stat-value" id="bestStreak">0</span>
      </div>
      <div class="panel-buttons">
        <button id="clearStatsBtn" class="btn danger-btn">🗑️ <span id="clearStatsText">Очистить статистику</span></button>
      </div>
    </div>

    <!-- Achievements Panel -->
    <div id="achievementsPanel" class="panel" style="display:none;">
      <h3 style="text-align:center;color:var(--accent);margin:8px 0;">🏆 <span id="achievementsTitle">Достижения</span></h3>
      <div id="achievementsList"></div>
      <div class="panel-buttons">
        <button id="clearAchievementsBtn" class="btn danger-btn">🗑️ <span id="clearAchievementsText">Сбросить достижения</span></button>
      </div>
    </div>

    <section id="table" class="panel" aria-label="Игровой стол">
      <h1 id="titleGame">
        <img src="icons/favicon-32.png" alt="🃏" class="game-title-icon">
        <span>Игра 21</span>
      </h1>
      <div id="deckStub" aria-hidden="true"></div>

      <!-- Тоасты -->
      <div id="toast"></div>

      <div class="hand" id="handPlayer">
        <div id="whoPlayer" class="who">Игрок</div>
        <div class="bubble" id="bubblePlayer"></div>
        <div class="cards" id="cardsPlayer"></div>
        <div class="total" id="totalPlayer"><span class="badge">= 0</span></div>
      </div>

      <div class="hand" id="handBot">
        <div id="whoBot" class="who">Бот</div>
        <div class="bubble" id="bubbleBot"></div>
        <div class="cards" id="cardsBot"></div>
        <div class="total" id="totalBot"><span class="badge">= 0</span></div>
      </div>

      <div class="btn-row">
        <button id="hitBtn" class="btn">
          🃏 <span id="hitText">Взять карту</span>
          <span class="kbd-hint">[H]</span>
        </button>
        <button id="stopBtn" class="btn">
          ✋ <span id="stopText">Стоп</span>
          <span class="kbd-hint">[S]</span>
        </button>
      </div>

      <div id="status">Готово</div>
    </section>

    <div id="postPanel" class="panel">
      <div id="postTitle" style="text-align:center;font-weight:800;margin-bottom:8px">Раунд завершён</div>
      <div id="postSummary"></div>
      <div class="row">
        <button id="nextBtn" class="btn">
          👉 <span id="nextText">Следующий раунд</span>
          <span class="kbd-hint">[N]</span>
        </button>
        <button id="resetBtn" class="btn">🔄 <span id="resetText">В меню</span></button>
      </div>
    </div>
  </div>

  <footer>by Huseyn Ahmedzade • ©</footer>

  <!-- Главное меню -->
  <div id="menuOverlay">
    <div id="menu" class="panel">
      <div id="menuTitle" class="menu-title">
        <img src="icons/favicon-32.png" alt="🃏" class="game-title-icon">
        <span>Игра 21</span>
      </div>
      <div id="menuSub" class="menu-sub">Выбери правила и начни матч</div>

      <div class="menu-row">
        <strong id="diffLabel">Сложность:</strong>
        <label><input type="radio" name="diff" value="easy"> <span id="diffEasy">Лёгкая</span></label>
        <label><input type="radio" name="diff" value="normal" checked> <span id="diffNormal">Обычная</span></label>
        <label><input type="radio" name="diff" value="hard"> <span id="diffHard">Сложная</span></label>
      </div>

      <div class="menu-row">
        <strong id="winsLabel">Раундов до победы:</strong>
        <select id="winTarget" class="spin">
          <option value="2">2</option>
          <option value="3" selected>3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </div>

      <div class="menu-row">
        <label class="chk"><input type="checkbox" id="sfxToggle" checked> <span id="sfxLabel">Звук</span></label>
        <label class="chk"><input type="checkbox" id="vibToggle" checked> <span id="vibLabel">Вибрация</span></label>
      </div>

      <div class="menu-btns">
        <button id="startBtn" class="btn" style="background:#3d7a3d">▶ <span id="startText">Начать матч</span></button>
        <button id="rulesBtn" class="btn">📜 <span id="rulesText">Правила</span></button>
      </div>
    </div>
  </div>

  <!-- Модальное окно конца матча -->
  <div id="resultOverlay">
    <div id="resultModal">
      <h3 id="modalTitle">Матч окончен</h3>
      <p id="modalText">Сообщение</p>
      <div class="row">
        <button id="okBtn" class="btn">ОК</button>
        <button id="toMenuBtn" class="btn"><span id="toMenuText">В меню</span></button>
      </div>
    </div>
  </div>

<script>
(() => {
  // ---------- локализация ----------
  const i18n = {
    ru:{
      score:'Счёт', game21:'Игра 21', player:'Игрок', bot:'Бот',
      hit:'Взять карту', stop:'Стоп', yourTurn:'Твой ход', botThinking:'Бот думает…',
      roundOver:'Раунд завершён', nextRound:'Следующий раунд', toMenu:'В меню', menu:'Меню',
      newRound:'🎮 Новый раунд!',
      deckEmptyYou:'🪙 Колода пуста! Ты не можешь взять карту.',
      deckEmptyBot:'🪙 Колода пуста! Бот не может взять карту.',
      youSaidStop:'Ты сказал: Стоп', botSaidStop:'Бот сказал: Стоп',
      youBust:'У тебя перебор. Бот выиграл раунд', botBust:'У бота перебор. Ты выиграл раунд',
      matchOver:'Матч окончен',
      youWonMatch:'🏆 Ты выиграл матч! Итог: {ps} : {bs}',
      botWonMatch:'💀 Бот победил в матче! Итог: {bs} : {ps}',
      scoring:'Подсчёт очков…',
      menuTitle:'Игра 21', menuSub:'Выбери правила и начни матч',
      difficulty:'Сложность:', easy:'Лёгкая', normal:'Обычная', hard:'Сложная',
      winsToWin:'Раундов до победы:', sound:'Звук', vib:'Вибрация',      
      ok:'ОК', rules:'Правила', start:'Начать матч',
      streak:'в серии', stats:'Статистика', achievements:'Достижения',
      winRate:'Процент побед', avgHand:'Средняя рука', bustRate:'Частота перебора',
      totalGames:'Всего игр', bestStreak:'Лучшая серия',
      clearStats:'Очистить статистику', clearAchievements:'Сбросить достижения',
      confirmClearStats:'Вы уверены, что хотите очистить всю статистику?',
      confirmClearAchievements:'Вы уверены, что хотите сбросить все достижения?',
      // Achievements
      achievementUnlocked:'Достижение разблокировано!',
      firstWin:'Первая победа', firstWinDesc:'Выиграй свой первый раунд',
      streak3:'Горячая серия', streak3Desc:'Выиграй 3 раунда подряд',
      streak5:'В огне!', streak5Desc:'Выиграй 5 раундов подряд',
      perfect21:'Идеальное 21', perfect21Desc:'Получи ровно 21 очко',
      comeback:'Возвращение', comebackDesc:'Выиграй матч, проигрывая 0:2',
      veteran:'Ветеран', veteranDesc:'Сыграй 50 раундов',
      lucky7:'Счастливая семёрка', lucky7Desc:'Выиграй с 7 и 7 и 7',
      noHit:'Без добора', noHitDesc:'Выиграй раунд, не взяв ни одной карты',
      master:'Мастер', masterDesc:'Выиграй 10 матчей'
    },
    en:{
      score:'Score', game21:'Twenty-One', player:'Player', bot:'Bot',
      hit:'Hit', stop:'Stand', yourTurn:'Your move', botThinking:'Bot is thinking…',
      roundOver:'Round finished', nextRound:'Next round', toMenu:'Menu', menu:'Menu',
      newRound:'🎮 New round!',
      deckEmptyYou:'🪙 Deck is empty! You cannot draw.',
      deckEmptyBot:'🪙 Deck is empty! Bot cannot draw.',
      youSaidStop:'You said: Stand', botSaidStop:'Bot said: Stand',
      youBust:'You busted. Bot wins the round', botBust:'Bot busted. You win the round',
      matchOver:'Match finished',
      youWonMatch:'🏆 You won the match! Final: {ps} : {bs}',
      botWonMatch:'💀 Bot won the match! Final: {bs} : {ps}',
      scoring:'Scoring…',
      menuTitle:'Twenty-One', menuSub:'Pick options and start',
      difficulty:'Difficulty:', easy:'Easy', normal:'Normal', hard:'Hard',
      winsToWin:'Rounds to win:', sound:'Sound', vib:'Vibration',
      ok:'OK', rules:'Rules', start:'Start match',
      streak:'streak', stats:'Statistics', achievements:'Achievements',
      winRate:'Win rate', avgHand:'Average hand', bustRate:'Bust rate',
      totalGames:'Total games', bestStreak:'Best streak',
      clearStats:'Clear statistics', clearAchievements:'Reset achievements',
      confirmClearStats:'Are you sure you want to clear all statistics?',
      confirmClearAchievements:'Are you sure you want to reset all achievements?',
      // Achievements
      achievementUnlocked:'Achievement unlocked!',
      firstWin:'First Win', firstWinDesc:'Win your first round',
      streak3:'Hot Streak', streak3Desc:'Win 3 rounds in a row',
      streak5:'On Fire!', streak5Desc:'Win 5 rounds in a row',
      perfect21:'Perfect 21', perfect21Desc:'Get exactly 21 points',
      comeback:'Comeback Kid', comebackDesc:'Win a match after being down 0:2',
      veteran:'Veteran', veteranDesc:'Play 50 rounds',
      lucky7:'Lucky Seven', lucky7Desc:'Win with 7, 7, and 7',
      noHit:'No Hit Wonder', noHitDesc:'Win a round without drawing any cards',
      master:'Master', masterDesc:'Win 10 matches'
    }
  };
  
  let lang = localStorage.lang || 'ru';
  const t = (k, vars={})=>{
    const raw = (i18n[lang]&&i18n[lang][k]) || i18n.ru[k] || k;
    return raw.replace('{ps}', vars.ps??'').replace('{bs}', vars.bs??'');
  };
  
  function applyLang(){
    document.getElementById('scoreLabel').textContent = t('score');
    document.getElementById('titleGame').querySelector('span').textContent = t('game21');
    document.getElementById('menuTitle').querySelector('span').textContent = t('game21');
    document.getElementById('whoPlayer').textContent  = t('player');
    document.getElementById('whoBot').textContent     = t('bot');
    document.getElementById('hitText').textContent    = t('hit');
    document.getElementById('stopText').textContent   = t('stop');
    document.getElementById('postTitle').textContent  = t('roundOver');
    document.getElementById('nextText').textContent   = t('nextRound');
    document.getElementById('resetText').textContent  = t('toMenu');
    document.getElementById('menuText').textContent   = t('menu');
    document.getElementById('menuSub').textContent    = t('menuSub');
    document.getElementById('diffLabel').textContent  = t('difficulty');
    document.getElementById('diffEasy').textContent   = t('easy');
    document.getElementById('diffNormal').textContent = t('normal');
    document.getElementById('diffHard').textContent   = t('hard');
    document.getElementById('winsLabel').textContent  = t('winsToWin');
    document.getElementById('sfxLabel').textContent   = t('sound');
    document.getElementById('vibLabel').textContent   = t('vib');
    document.getElementById('startText').textContent  = t('start');
    document.getElementById('rulesText').textContent  = t('rules');
    document.getElementById('okBtn').textContent      = t('ok');
    document.getElementById('toMenuText').textContent = t('toMenu');
    
    // Stats panel translations
    const statsTitle = document.getElementById('statsTitle');
    if(statsTitle) statsTitle.textContent = t('stats');
    
    const statLabels = {
      'winRateLabel': 'winRate',
      'avgHandLabel': 'avgHand',
      'bustRateLabel': 'bustRate',
      'totalGamesLabel': 'totalGames',
      'bestStreakLabel': 'bestStreak'
    };
    
    for(const [elementId, translationKey] of Object.entries(statLabels)) {
      const element = document.getElementById(elementId);
      if(element) element.textContent = t(translationKey) + ':';
    }
    
    document.getElementById('clearStatsText').textContent = t('clearStats');
    document.getElementById('achievementsTitle').textContent = t('achievements');
    document.getElementById('clearAchievementsText').textContent = t('clearAchievements');
    
    statusEl.textContent = t('yourTurn');
    
    // Update achievements display
    displayAchievements();
  }

  // ---------- состояние ----------
  let deck = [];
  let player = [];
  let bot = [];
  let playerStop = false;
  let botStop = false;
  let roundOver = false;
  let phase = 'player';
  let animLock = false;
  let difficulty = 'normal';
  let winTarget = 3;
  let playerScore = 0;
  let botScore = 0;
  let matchesWon = 0;

  // Statistics tracking
  let stats = {
    totalRounds: 0,
    playerWins: 0,
    botWins: 0,
    draws: 0,
    totalPlayerHands: 0,
    totalBotHands: 0,
    playerBusts: 0,
    botBusts: 0,
    bestStreak: 0,
    currentStreak: 0  // Only track winning streaks
  };

  // Achievements
  let achievements = {
    firstWin: false,
    streak3: false,
    streak5: false,
    perfect21: false,
    comeback: false,
    veteran: false,
    lucky7: false,
    noHit: false,
    master: false
  };

  // Load data
  function loadStats() {
    const saved = localStorage.getItem('game21Stats');
    if (saved) stats = JSON.parse(saved);
    const savedMatches = localStorage.getItem('game21Matches');
    if (savedMatches) matchesWon = parseInt(savedMatches, 10);
  }

  function saveStats() {
    localStorage.setItem('game21Stats', JSON.stringify(stats));
    localStorage.setItem('game21Matches', matchesWon);
  }

  function loadAchievements() {
    const saved = localStorage.getItem('game21Achievements');
    if (saved) achievements = JSON.parse(saved);
  }

  function saveAchievements() {
    localStorage.setItem('game21Achievements', JSON.stringify(achievements));
  }

  function clearStats() {
    if (confirm(t('confirmClearStats'))) {
      stats = {
        totalRounds: 0,
        playerWins: 0,
        botWins: 0,
        draws: 0,
        totalPlayerHands: 0,
        totalBotHands: 0,
        playerBusts: 0,
        botBusts: 0,
        bestStreak: 0,
        currentStreak: 0
      };
      matchesWon = 0;
      saveStats();
      updateStatsDisplay();
      showToast('📊 ' + (lang === 'ru' ? 'Статистика очищена' : 'Statistics cleared'), 'info');
    }
  }

  function clearAchievements() {
    if (confirm(t('confirmClearAchievements'))) {
      achievements = {
        firstWin: false,
        streak3: false,
        streak5: false,
        perfect21: false,
        comeback: false,
        veteran: false,
        lucky7: false,
        noHit: false,
        master: false
      };
      saveAchievements();
      displayAchievements();
      showToast('🏆 ' + (lang === 'ru' ? 'Достижения сброшены' : 'Achievements reset'), 'info');
    }
  }

  function updateStatsDisplay() {
    const winRate = stats.totalRounds > 0 ? Math.round((stats.playerWins / stats.totalRounds) * 100) : 0;
    const avgPlayerHand = stats.playerWins + stats.draws > 0 ? 
      Math.round(stats.totalPlayerHands / (stats.playerWins + stats.draws)) : 0;
    const bustRate = stats.totalRounds > 0 ? Math.round((stats.playerBusts / stats.totalRounds) * 100) : 0;
    
    document.getElementById('winRate').textContent = winRate + '%';
    document.getElementById('avgHand').textContent = avgPlayerHand;
    document.getElementById('bustRate').textContent = bustRate + '%';
    document.getElementById('totalGames').textContent = stats.totalRounds;
    document.getElementById('bestStreak').textContent = stats.bestStreak;
  }

  // Achievement checking
  function checkAchievements(winner) {
    const ps = sum(player);
    let newAchievement = null;
    
    // First Win
    if (!achievements.firstWin && winner === 'player') {
      achievements.firstWin = true;
      newAchievement = { id: 'firstWin', icon: '🎯' };
    }
    
    // Perfect 21
    if (!achievements.perfect21 && winner === 'player' && ps === 21) {
      achievements.perfect21 = true;
      newAchievement = { id: 'perfect21', icon: '💎' };
    }
    
    // Streak achievements
    if (!achievements.streak3 && stats.currentStreak === 3) {
      achievements.streak3 = true;
      newAchievement = { id: 'streak3', icon: '🔥' };
    }
    
    if (!achievements.streak5 && stats.currentStreak === 5) {
      achievements.streak5 = true;
      newAchievement = { id: 'streak5', icon: '🌟' };
    }
    
    // Lucky 7 (three 7s)
    if (!achievements.lucky7 && winner === 'player' && player.length === 3 && 
        player.every(card => card === 7)) {
      achievements.lucky7 = true;
      newAchievement = { id: 'lucky7', icon: '🎰' };
    }
    
    // No Hit Wonder
    if (!achievements.noHit && winner === 'player' && player.length === 2) {
      achievements.noHit = true;
      newAchievement = { id: 'noHit', icon: '🎯' };
    }
    
    // Veteran
    if (!achievements.veteran && stats.totalRounds >= 50) {
      achievements.veteran = true;
      newAchievement = { id: 'veteran', icon: '🎖️' };
    }
    
    // Master
    if (!achievements.master && matchesWon >= 10) {
      achievements.master = true;
      newAchievement = { id: 'master', icon: '👑' };
    }
    
    if (newAchievement) {
      showAchievementNotification(newAchievement);
      saveAchievements();
      displayAchievements();
    }
  }

  function checkComebackAchievement() {
    if (!achievements.comeback && playerScore >= winTarget && botScore === winTarget - 1) {
      // Check if player was down 0:2
      achievements.comeback = true;
      showAchievementNotification({ id: 'comeback', icon: '💪' });
      saveAchievements();
      displayAchievements();
    }
  }

  function showAchievementNotification(achievement) {
    const notification = document.createElement('div');
    notification.className = 'achievement-notification';
    notification.innerHTML = `
      ${achievement.icon} ${t('achievementUnlocked')}<br>
      <strong>${t(achievement.id)}</strong>
    `;
    document.body.appendChild(notification);
    
    playSfx('achievement');
    buzz(100);
    
    setTimeout(() => {
      notification.style.transform = 'translate(-50%, -100px)';
      notification.style.opacity = '0';
      setTimeout(() => notification.remove(), 500);
    }, 3000);
  }

  function displayAchievements() {
    const list = document.getElementById('achievementsList');
    list.innerHTML = '';
    
    const achievementData = [
      { id: 'firstWin', icon: '🎯' },
      { id: 'streak3', icon: '🔥' },
      { id: 'streak5', icon: '🌟' },
      { id: 'perfect21', icon: '💎' },
      { id: 'comeback', icon: '💪' },
      { id: 'veteran', icon: '🎖️' },
      { id: 'lucky7', icon: '🎰' },      
      { id: 'noHit', icon: '🎯' },
      { id: 'master', icon: '👑' }
    ];
    
    achievementData.forEach(data => {
      const unlocked = achievements[data.id];
      const item = document.createElement('div');
      item.className = `achievement-item ${unlocked ? 'unlocked' : 'locked'}`;
      item.innerHTML = `
        <div class="achievement-icon">${data.icon}</div>
        <div class="achievement-info">
          <div class="achievement-name">${t(data.id)}</div>
          <div class="achievement-desc">${t(data.id + 'Desc')}</div>
        </div>
        <div class="achievement-status">${unlocked ? '✅' : '🔒'}</div>
      `;
      list.appendChild(item);
    });
  }

  // звук/вибрация
  let sfxOn = localStorage.sfxOn ? localStorage.sfxOn==='1' : true;
  let vibOn = localStorage.vibOn ? localStorage.vibOn==='1' : true;
  let actx = null;
  function ensureAudio(){ if(!actx){ const C=window.AudioContext||window.webkitAudioContext; actx=new C(); } if(actx.state==='suspended') actx.resume(); }
  function tone(freq=440, dur=0.12, type='sine', vol=0.05){
    if(!sfxOn) return;
    ensureAudio();
    const o=actx.createOscillator(), g=actx.createGain();
    o.type=type; o.frequency.value=freq; o.connect(g); g.connect(actx.destination);
    const t0=actx.currentTime; g.gain.setValueAtTime(0.0001,t0);
    g.gain.linearRampToValueAtTime(vol,t0+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,t0+dur);
    o.start(); o.stop(t0+dur);
  }
  function playSfx(kind){
    switch(kind){
      case 'deal': tone(660,0.08,'triangle',0.03); break;
      case 'click': tone(520,0.06,'square',0.04); break;
      case 'stop': tone(340,0.08,'square',0.03); break;
      case 'win': tone(880,0.12,'triangle',0.05); setTimeout(()=>tone(1046,0.14,'triangle',0.05),100); break;
      case 'lose': tone(220,0.18,'sawtooth',0.06); break;
      case 'bust': tone(160,0.22,'sawtooth',0.06); break;
      case 'streak': tone(1320,0.15,'sine',0.04); setTimeout(()=>tone(1568,0.15,'sine',0.04),100); break;
      case 'achievement': 
        tone(1047,0.1,'sine',0.05); 
        setTimeout(()=>tone(1319,0.1,'sine',0.05),100);
        setTimeout(()=>tone(1568,0.1,'sine',0.05),200);
        setTimeout(()=>tone(2093,0.2,'sine',0.05),300);
        break;
    }
  }
  function buzz(ms=50){ if(vibOn && navigator.vibrate) navigator.vibrate(ms); }

  // ---------- DOM ----------
  const menuOverlay = document.getElementById('menuOverlay');
  const startBtn = document.getElementById('startBtn');
  const rulesBtn = document.getElementById('rulesBtn');
  const menuBtn = document.getElementById('menuBtn');
  const statsBtn = document.getElementById('statsBtn');
  const achievementsBtn = document.getElementById('achievementsBtn');
  const winInput = document.getElementById('winTarget');
  const sfxToggle = document.getElementById('sfxToggle');
  const vibToggle = document.getElementById('vibToggle');

  const scoreText = document.getElementById('scoreText');
  const chipsL = document.getElementById('chipsL');
  const chipsR = document.getElementById('chipsR');

  const cardsPlayer = document.getElementById('cardsPlayer');
  const cardsBot = document.getElementById('cardsBot');
  const totalPlayer = document.getElementById('totalPlayer');
  const totalBot = document.getElementById('totalBot');

  const bubblePlayer = document.getElementById('bubblePlayer');
  const bubbleBot = document.getElementById('bubbleBot');

  const hitBtn = document.getElementById('hitBtn');
  const stopBtn = document.getElementById('stopBtn');
  const statusEl = document.getElementById('status');

  const postPanel = document.getElementById('postPanel');
  const postSummary = document.getElementById('postSummary');
  const nextBtn = document.getElementById('nextBtn');
  const resetBtn = document.getElementById('resetBtn');

  const deckStub = document.getElementById('deckStub');
  const statsPanel = document.getElementById('statsPanel');
  const achievementsPanel = document.getElementById('achievementsPanel');
  const streakIndicator = document.getElementById('streakIndicator');

  const clearStatsBtn = document.getElementById('clearStatsBtn');
  const clearAchievementsBtn = document.getElementById('clearAchievementsBtn');

  // модалка конца матча
  const resultOverlay = document.getElementById('resultOverlay');
  const modalTitle = document.getElementById('modalTitle');
  const modalText  = document.getElementById('modalText');
  const okBtn      = document.getElementById('okBtn');
  const toMenuBtn  = document.getElementById('toMenuBtn');

  // Language buttons
  const langBtns = document.querySelectorAll('.lang-btn');
  langBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      langBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      lang = btn.dataset.lang;
      localStorage.lang = lang;
      applyLang();
      drawChips();
      updateStatsDisplay();
    });
  });

  // Set active language button
  langBtns.forEach(btn => {
    if (btn.dataset.lang === lang) btn.classList.add('active');
    else btn.classList.remove('active');
  });

  // ---------- утилиты/колода ----------
  const rng = arr => arr[Math.floor(Math.random()*arr.length)];
  const sum = a => a.reduce((s,x)=>s+x,0);
  const newDeck = () => Array.from({length:11}, (_,i)=>i+1);

  function dealStart(d){
    let tries=0;
    while(true){
      const a = rng(d), b = rng(d);
      if(a!==b && a+b<=11){
        d.splice(d.indexOf(a),1);
        d.splice(d.indexOf(b),1);
        return [a,b];
      }
      if(++tries>200){
        return [getCard(d), getCard(d)];
      }
    }
  }
  function getCard(d){
    if(d.length===0) return null;
    const i = Math.floor(Math.random()*d.length);
    return d.splice(i,1)[0];
  }

  // Enhanced bot logic
  function getSeenCards() {
    return [...player, ...bot];
  }

  function adjustedBustProb(total, deck, seenCards) {
    const remainingDeck = [...deck];
    seenCards.forEach(card => {
      const idx = remainingDeck.indexOf(card);
      if(idx > -1) remainingDeck.splice(idx, 1);
    });
    return bustProb(total, remainingDeck);
  }

  function bustProb(total, d){
    const need = 22 - total;
    if(need<=1) return 1;
    const bad = d.filter(v=>v>=need).length;
    return d.length ? bad/d.length : 1;
  }

  function botDecision(total, d, playerTotal = null){
    if(total >= 20) return 'stop';
    if(total <= 11) return 'hit';
    
    let p = bustProb(total, d);
    
    if(difficulty === 'hard') {
      const seenCards = getSeenCards();
      p = adjustedBustProb(total, d, seenCards);
    }
    
    let risk = (difficulty==='easy'? 0.25 : difficulty==='hard'? 0.55 : 0.40);
    
    if(playerTotal && playerStop) {
      if(total > playerTotal) return 'stop';
      if(total === playerTotal && difficulty !== 'hard') return 'stop';
      risk = Math.min(risk * 1.3, 0.7);
    }
    
    if(difficulty === 'hard') {
      if(total === 16) return p < 0.5 ? 'hit' : 'stop';
      if(total === 17) return p < 0.35 ? 'hit' : 'stop';
      if(total === 18) return p < 0.2 ? 'hit' : 'stop';
    }
    
    return (p < risk) ? 'hit' : 'stop';
  }

  // ---------- карточки + анимация ----------
  const SUITS = [
    {sym:'♠', color:'black'},
    {sym:'♥', color:'red'},
    {sym:'♣', color:'black'},
    {sym:'♦', color:'red'}
  ];
  function suitFor(value){ return SUITS[(value-1)%4]; }

  function makeCardEl(value, owner){
    const s = suitFor(value);
    const card = document.createElement('div');
    card.className = 'card ' + (owner==='player' ? '' : 'grey') + ' ' + (s.color==='red'?'red':'black') + ' enter dealing';
    card.innerHTML = `
      <div class="corner tl">${s.sym}</div>
      <div class="value">${value}</div>
      <div class="corner br">${s.sym}</div>
    `;
    requestAnimationFrame(()=>{
      card.classList.remove('enter');
      setTimeout(()=>card.classList.remove('dealing'), 400);
    });
    return card;
  }

  function cls(t){ return t>21?'bad':t===21?'win':t>=17?'good':'' }
  function renderTotals(){
    const pt = sum(player), bt = sum(bot);
    totalPlayer.innerHTML = `<span class="badge ${cls(pt)}">= ${pt}</span>`;
    totalBot.innerHTML    = `<span class="badge ${cls(bt)}">= ${bt}</span>`;
  }

  // с анимацией из колоды
  function addCardToDOM(owner, value){
    const cont = owner==='player'?cardsPlayer:cardsBot;
    
    deckStub.classList.add('pulse');
    setTimeout(()=>deckStub.classList.remove('pulse'), 400);

    const fly = makeCardEl(value, owner);
    fly.classList.add('fly');
    document.body.appendChild(fly);

    const deckRect = deckStub.getBoundingClientRect();
    const targetRect = cont.getBoundingClientRect();
    fly.style.left = deckRect.left + 'px';
    fly.style.top  = deckRect.top  + 'px';

    const dx = (targetRect.left + targetRect.width/2) - deckRect.left - 28;
    const dy = (targetRect.top  + 8) - deckRect.top - 39;

    requestAnimationFrame(()=>{ fly.style.transform = `translate(${dx}px, ${dy}px) scale(1)`; });

    setTimeout(()=>{
      fly.remove();

      const el = makeCardEl(value, owner);
      cont.appendChild(el);
      el.classList.add('flash');
      const pill = document.createElement('span');
      pill.className='pill'; pill.textContent = `+${value}`;
      el.appendChild(pill);
      setTimeout(()=>{ el.classList.remove('flash'); pill.remove(); }, 450);

      renderTotals();
      playSfx('deal');
    }, 340);
  }

  // ---------- баблы + тоасты ----------
  function bubble(owner, text){
    const b = owner==='player'? bubblePlayer : bubbleBot;
    b.textContent = text; b.classList.add('show');
    setTimeout(()=>b.classList.remove('show'), 1000);
  }

  let toastQueue = []; let toastActive = false;
  function showToast(text, type='info', duration=1000){
    toastQueue.push({text, type, duration});
    if (!toastActive) runToast();
  }
  function runToast(){
    const zone = document.getElementById('toast');
    const item = toastQueue.shift();
    if (!item){ toastActive = false; return; }
    toastActive = true;
    zone.innerHTML = `<div class="toast ${item.type} show">${item.text}</div>`;
    setTimeout(() => {
      zone.firstChild?.classList.remove('show');
      setTimeout(() => { zone.innerHTML = ''; runToast(); }, 280);
    }, item.duration);
  }

  // ---------- счёт и серии ----------
  function updateStreak(winner) {
    if(winner === 'player') {
      stats.currentStreak++;
      if(stats.currentStreak > stats.bestStreak) {
        stats.bestStreak = stats.currentStreak;
      }
    } else {
      stats.currentStreak = 0;
    }
    
    // Display streak if 3 or more
    if(stats.currentStreak >= 3) {
      streakIndicator.textContent = `🔥 ${stats.currentStreak} ${t('streak')}`;
      streakIndicator.className = 'streak-indicator show fire';
      showToast(`🔥 ${stats.currentStreak} ${t('streak')}!`, 'streak', 1500);
      if(stats.currentStreak === 3) playSfx('streak');
    } else {
      streakIndicator.classList.remove('show');
    }
  }

  function drawChips(){
    scoreText.textContent = (lang==='ru' ? `Ты ${playerScore} - ${botScore} Бот`
                                          : `You ${playerScore} - ${botScore} Bot`);
    const draw = (el, n, activeClass) => {
      el.innerHTML = '';
      for(let i=0;i<winTarget;i++){
        const c = document.createElement('span');
        c.className = 'chip ' + activeClass + (i<n ? ' active' : '');
        el.appendChild(c);
      }
    };
    draw(chipsL, playerScore, 'green');
    draw(chipsR, botScore, 'red');
  }

  // ---------- валидатор цели матча ----------
  function ensureWinTarget(){
    const v = parseInt(winInput.value, 10);
    winTarget = [2,3,4,5].includes(v) ? v : 3;
    winInput.value = String(winTarget);
    winInput.addEventListener('change', ()=>{ ensureWinTarget(); drawChips(); });
  }

  // ---------- раунд ----------
  function startRound(){
    deck = newDeck();
    player = dealStart(deck);
    bot = dealStart(deck);
    playerStop = botStop = roundOver = false;
    phase = 'player';
    animLock = false;

    cardsPlayer.innerHTML = ''; cardsBot.innerHTML='';    
    player.forEach(v=>cardsPlayer.appendChild(makeCardEl(v,'player')));
    bot.forEach(v=>cardsBot.appendChild(makeCardEl(v,'bot')));
    renderTotals();

    statusEl.textContent = t('yourTurn');
    statusEl.className = '';
    postPanel.style.display = 'none';
    hitBtn.disabled = false; stopBtn.disabled = false;

    document.getElementById('handBot').classList.remove('thinking');

    showToast(t('newRound'),'info');
  }

  function checkEnd(){
    if(playerStop && botStop && !roundOver){
      const ps = sum(player), bs = sum(bot);
      if(ps>bs){ endRound('player'); }
      else if(ps<bs){ endRound('bot'); }
      else { endRound('draw'); }
      return true;
    }
    return false;
  }

  // ---------- модалка конца матча ----------
  function showMatchEndModal(text){
    modalTitle.textContent = t('matchOver');
    modalText.textContent  = text;
    resultOverlay.style.display = 'flex';
  }
  function hideMatchEndModal(){ resultOverlay.style.display = 'none'; }

  function endRound(winner, { silent=false } = {}){
    if (roundOver) return;
    roundOver = true;

    hitBtn.disabled = true; stopBtn.disabled = true;

    // Update statistics
    stats.totalRounds++;
    const ps = sum(player), bs = sum(bot);
    
    if(ps <= 21) {
      stats.totalPlayerHands += ps;
    }
    if(bs <= 21) {
      stats.totalBotHands += bs;
    }

    if(winner==='player'){
      playerScore++; 
      stats.playerWins++;
      statusEl.className='ok'; 
      if(!silent) showToast('✅ ' + (lang==='ru'?'Ты выиграл раунд!':'You won the round!'),'win');
      playSfx('win');
    }else if(winner==='bot'){
      botScore++; 
      stats.botWins++;
      statusEl.className='bad'; 
      if(!silent) showToast('❌ ' + (lang==='ru'?'Бот выиграл раунд!':'Bot won the round!'),'lose');
      playSfx('lose');
    }else{
      stats.draws++;
      statusEl.className='neutral'; 
      if(!silent) showToast('🤝 ' + (lang==='ru'?'Ничья':'Draw'),'info');
    }

    // Update streak
    updateStreak(winner);
    
    // Check achievements
    checkAchievements(winner);
    
    // Save stats
    saveStats();
    updateStatsDisplay();

    drawChips();
    statusEl.textContent = t('roundOver');

    // подпись и пульс на фишке
    if(winner==='player'){
      const i = playerScore-1; const chip = chipsL.children[i];
      if(chip){ chip.classList.add('win'); chip.title = `Round: ${ps}:${bs}`; }
    }else if(winner==='bot'){
      const i = botScore-1; const chip = chipsR.children[i];
      if(chip){ chip.classList.add('win'); chip.title = `Round: ${ps}:${bs}`; }
    }

    ensureWinTarget();

    // конец матча — с паузой
    if (playerScore >= winTarget || botScore >= winTarget) {
      if (playerScore > botScore) {
        matchesWon++;
        saveStats();
        checkComebackAchievement();
        checkAchievements('match');
      }
      
      const msg = (playerScore > botScore)
        ? t('youWonMatch',{ps:playerScore, bs:botScore})
        : t('botWonMatch',{ps:playerScore, bs:botScore});
      const MODAL_DELAY = 800;
      statusEl.textContent = t('scoring');
      postPanel.style.display = 'none';
      setTimeout(() => showMatchEndModal(msg), MODAL_DELAY);
      return;
    }

    postSummary.textContent = (lang==='ru'
      ? `Ты ${ps} : ${bs} Бот — ` + (ps>bs ? 'победа' : ps<bs ? 'поражение' : 'ничья')
      : `You ${ps} : ${bs} Bot — ` + (ps>bs ? 'win' : ps<bs ? 'loss' : 'draw'));
    postPanel.style.display = 'block';
  }

  // ---------- ходы ----------
  function onHit(){
    if(roundOver || phase!=='player' || playerStop || animLock) return;
    const card = getCard(deck);
    if(card==null){
      showToast(t('deckEmptyYou'),'info');
      playerStop = true; bubble('player','—');
      return switchToBot();
    }
    animLock = true;
    player.push(card);
    addCardToDOM('player', card);

    const total = sum(player);
    if(total>21){
      stats.playerBusts++;
      showToast(t('youBust'),'lose', 1400);
      playSfx('bust'); buzz(70);
      animLock = false;
      return endRound('bot', { silent:true });
    }
    if(total===21){ playerStop = true; bubble('player','21'); }

    animLock = false;
    switchToBot();
  }

  function onStop(){
    if(roundOver || phase!=='player' || animLock) return;
    playerStop = true;
    bubble('player', lang==='ru'?'Стоп':'Stand');
    showToast(t('youSaidStop'),'info');
    playSfx('stop');
    switchToBot();
  }

  function switchToBot(){
    phase='bot';
    hitBtn.disabled = true; stopBtn.disabled = true;
    statusEl.textContent = '🤖 ' + t('botThinking');
    statusEl.classList.add('thinking');
    document.getElementById('handBot').classList.add('thinking');
    setTimeout(botStep, 800);
  }

  function afterBot(){
    document.getElementById('handBot').classList.remove('thinking');
    if(checkEnd()) return;
    if(playerStop && !botStop){
      setTimeout(botStep, 800);
    }else{
      phase='player';
      statusEl.textContent = t('yourTurn');
      statusEl.classList.remove('thinking');
      hitBtn.disabled = false; stopBtn.disabled = false;
    }
  }

  function botStep(){
    if(roundOver || animLock) return setTimeout(botStep, 150);
    const bsum = sum(bot);
    if(bsum>=21){
      if(!botStop){ botStop = true; bubble('bot','21'); }
      return afterBot();
    }
    
    const playerTotal = playerStop ? sum(player) : null;
    const decision = botDecision(bsum, deck, playerTotal);
    
    if(decision==='hit'){
      const card = getCard(deck);
      if(card==null){
        showToast(t('deckEmptyBot'),'info');
        botStop = true;
        return afterBot();
      }
      animLock = true;
      bot.push(card);
      addCardToDOM('bot', card);
      if(sum(bot)>21){
        stats.botBusts++;
        showToast(t('botBust'),'win', 1400);
        playSfx('bust'); buzz(70);
        animLock=false;
        return endRound('player', { silent:true });
      }
      animLock=false;
      return afterBot();
    }else{
      botStop = true;
      bubble('bot', lang==='ru'?'Стоп':'Stand');
      showToast(t('botSaidStop'),'info');
      playSfx('stop');
      return afterBot();
    }
  }

  // ---------- меню / матч ----------
  function startMatch(){
    difficulty = document.querySelector('input[name="diff"]:checked')?.value || 'normal';
    ensureWinTarget();
    playerScore=0; botScore=0;
    stats.currentStreak = 0;
    streakIndicator.classList.remove('show');
    drawChips();
    hideMatchEndModal();
    menuOverlay.style.display='none';
    startRound();
  }

  function backToMenu(reset=false){
    if(reset){ 
      playerScore=botScore=0; 
      stats.currentStreak = 0;
      streakIndicator.classList.remove('show');
      drawChips(); 
    }
    hideMatchEndModal();
    menuOverlay.style.display='flex';
    postPanel.style.display='none';
    statsPanel.style.display='none';
    achievementsPanel.style.display='none';
    statusEl.textContent='—';
    statusEl.className='';
    cardsPlayer.innerHTML=''; cardsBot.innerHTML='';
    totalPlayer.innerHTML='<span class="badge">= 0</span>';
    totalBot.innerHTML='<span class="badge">= 0</span>';
  }

  function showRules(){
    alert(
`${t('rules')}

— ${lang==='ru'?'В начале по 2 карты.':'Start with 2 cards.'}
— ${lang==='ru'?'Твой ход первый: «Взять» или «Стоп».':'You move first: Hit or Stand.'}
— ${lang==='ru'?'Перебор мгновенно завершает раунд.':'Bust ends the round immediately.'}
— ${lang==='ru'?'Матч до N побед (макс. 5).':'Match to N wins (max 5).'}

${lang==='ru'?'Горячие клавиши:':'Keyboard shortcuts:'}
[H] - ${lang==='ru'?'Взять карту':'Hit'}
[S] - ${lang==='ru'?'Стоп':'Stand'}
[N] - ${lang==='ru'?'Следующий раунд':'Next round'}
[ESC] - ${lang==='ru'?'Меню':'Menu'}`
    );
  }

  // Accessibility helper
  function announceAction(action) {
    const announcement = document.createElement('div');
    announcement.setAttribute('role', 'status');
    announcement.setAttribute('aria-live', 'polite');
    announcement.className = 'sr-only';
    announcement.textContent = action;
    document.body.appendChild(announcement);
    setTimeout(() => announcement.remove(), 1000);
  }

  // ---------- события ----------
  hitBtn.addEventListener('click', ()=>{ playSfx('click'); onHit(); });
  stopBtn.addEventListener('click', ()=>{ playSfx('click'); onStop(); });
  nextBtn.addEventListener('click', ()=>{ playSfx('click'); startRound(); });
  resetBtn.addEventListener('click', ()=>{ playSfx('click'); backToMenu(true); });
  startBtn.addEventListener('click', ()=>{ playSfx('click'); startMatch(); });
  rulesBtn.addEventListener('click', ()=>{ playSfx('click'); showRules(); });
  menuBtn.addEventListener('click', ()=>{ playSfx('click'); backToMenu(true); });
  
  statsBtn.addEventListener('click', ()=>{ 
    playSfx('click'); 
    achievementsPanel.style.display = 'none';
    statsPanel.style.display = statsPanel.style.display === 'none' ? 'block' : 'none';
    updateStatsDisplay();
  });
  
  achievementsBtn.addEventListener('click', ()=>{ 
    playSfx('click'); 
    statsPanel.style.display = 'none';
    achievementsPanel.style.display = achievementsPanel.style.display === 'none' ? 'block' : 'none';
    displayAchievements();
  });

  clearStatsBtn.addEventListener('click', ()=>{ playSfx('click'); clearStats(); });
  clearAchievementsBtn.addEventListener('click', ()=>{ playSfx('click'); clearAchievements(); });

  okBtn.addEventListener('click', ()=>{ playSfx('click'); backToMenu(true); });
  toMenuBtn.addEventListener('click', ()=>{ playSfx('click'); backToMenu(true); });
  resultOverlay.addEventListener('click', (e)=>{ if(e.target===resultOverlay) backToMenu(true); });

  // настройки
  sfxToggle.checked = sfxOn;
  vibToggle.checked = vibOn;
  sfxToggle.addEventListener('change', ()=>{ sfxOn = sfxToggle.checked; localStorage.sfxOn=sfxOn?'1':'0'; if(sfxOn) ensureAudio(); });
  vibToggle.addEventListener('change', ()=>{ vibOn = vibToggle.checked; localStorage.vibOn=vibOn?'1':'0'; });

  // Enhanced keyboard shortcuts
  document.addEventListener('keydown', (e)=>{
    if(resultOverlay.style.display==='flex') {
      if(e.key==='Escape' || e.key==='Enter') backToMenu(true);
      return;
    }
    if(menuOverlay.style.display!=='none'){
      if(e.key==='Enter') startMatch();
      return;
    }
    
    switch(e.key.toLowerCase()) {
      case 'h':
        if(!hitBtn.disabled) { 
          e.preventDefault(); 
          onHit(); 
          announceAction(t('hit'));
        }
        break;
      case 's':
        if(!stopBtn.disabled) { 
          e.preventDefault(); 
          onStop(); 
          announceAction(t('stop'));
        }
        break;
      case 'n':
        if(roundOver && postPanel.style.display !== 'none') { 
          e.preventDefault(); 
          startRound(); 
        }
        break;
      case ' ':
        e.preventDefault(); 
        if(!hitBtn.disabled) onHit();
        break;
      case 'enter':
        if(!stopBtn.disabled) onStop();
        break;
      case 'escape':
        backToMenu(true);
        break;
    }
  });

  // Performance optimization - debounce resize
  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      // Adjust any layout if needed
    }, 250);
  });

  // первичный рендер
  loadStats();
  loadAchievements();
  applyLang();
  drawChips();
  updateStatsDisplay();
  displayAchievements();
})();
</script>
</body>
</html>
